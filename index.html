<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Test</title>
    <link rel="icon" href="data:," />
    <style>
        body {
            text-align: center;
        }

        div[contenteditable="true"] {
            width: 800px;
            max-width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            margin: 10px auto;
            padding: 10px;
            text-align: left;
            font-family: Arial, Microsoft Yahei;
            font-size: 14px;
            display: inline-block;
            word-break: break-all;
            white-space: break-spaces;
            overflow-wrap: break-word;
            overflow: auto;
        }

        div[contenteditable="true"] img {
            cursor: grab;
            max-width: 100%;
        }
    </style>
</head>

<body>
    <div id="test" contenteditable="true"></div>
    <script>
        // [redo function] [reduce undo step] [filter event] [mouseclick/touchstart/upload] [get file] .replace(/<[^>]*>?/gm, '').trim()
        class DropEditor {
            static rev = [];
            static hot = false;
            static tmp = new Text();
            static wait = 0;
            static move = false;
            static get(event) {
                if (event?.dataTransfer?.types.includes("Files")) {
                }
                else if (event?.dataTransfer?.types.includes("text/html")) {
                    this.tmp = new Range().createContextualFragment(
                        event.dataTransfer.getData("text/html")
                            .replaceAll("\v", "\n\t")
                            .replaceAll(/\<img\s+.*?src=\"([^"]+)\".*?\>/ig, "\v$1\v")
                            .replaceAll(/(\<(?:option|td|th)(?:\>|\s+.*?\>))/ig, " $1")
                            .replaceAll(/(\<(?:address|article|aside|blockquote|br|caption|dd|details|dialog|div|dl|dt|fieldset|figcaption|figure|footer|form|h\d|header|hr|iframe|legend|li|main|nav|ol|p|pre|ruby|section|summary|table|tbody|tfoot|thead|tr|ul)(?:\>|\s+.*?\>))/ig, "\n$1")
                    );
                    this.tmp.replaceChildren(
                        new Range().createContextualFragment(
                            this.tmp.textContent
                                .replaceAll(/[\u00A0-\u9999<>\&\'\"\\]/ig, _ => "&#" + _.charCodeAt(0) + ";")
                                .replaceAll(/\v(.*?)\v/ig, "<img src=\"$1\" alt=\"\" />")
                                .replaceAll(/\n{3,}/g, "\n\n")
                                .trim()
                        )
                    );
                }
                else if (event?.dataTransfer?.types.includes("text/plain")) {
                    this.tmp = new Text(event.dataTransfer.getData("text/plain"));
                }
                else {
                    this.tmp = new Text();
                }
            }
            static put() {
                const rgNow = window.getSelection().getRangeAt(0);
                rgNow.deleteContents();
                rgNow.insertNode(this.tmp);
                rgNow.collapse();
            };
            static save(area) {
                const child = Array.from(area.childNodes);
                const rgNow = window.getSelection().getRangeAt(0);
                const rgAll = new Range();
                rgAll.selectNodeContents(area);
                this.rev.push({
                    startIndex: child.indexOf(rgNow.startContainer),
                    startOffset: rgNow.startOffset,
                    endIndex: child.indexOf(rgNow.endContainer),
                    endOffset: rgNow.endOffset,
                    dom: child.length ? rgAll.cloneContents() : rgAll.createContextualFragment("\r")
                });
            };
            static undo(area, pop = true) {
                if (!this.rev.length) { return; }
                const ver = (pop ? this.rev.pop() : this.rev[this.rev.length - 1]);
                area.replaceChildren(ver.dom.cloneNode(true));
                const rgNew = new Range();
                (ver.startIndex < 0) ? rgNew.setStart(area.childNodes[ver.startOffset], 0) : rgNew.setStart(area.childNodes[ver.startIndex], ver.startOffset);
                (ver.endIndex < 0) ? rgNew.setEnd(area.childNodes[ver.endOffset], 0) : rgNew.setEnd(area.childNodes[ver.endIndex], ver.endOffset);
                const sl = window.getSelection();
                sl.removeAllRanges();
                sl.addRange(rgNew);
            };
            static redo(area) {
            };
            static file(area) {
                alert("File Upload !!");
            }
            static press(area) {
                this.move = false;
                this.wait = window.setTimeout(this.file.bind(null, area), 3000);
            }
            static loose() {
                window.clearTimeout(this.wait);
            }
            static watch(selector) {
                const area = document.querySelector(selector);
                const that = this;
                area.addEventListener("beforeinput", function (e) {
                    console.log(e);
                    if (e.inputType.startsWith("format")) {
                        e.preventDefault();
                        return;
                    }
                    if (e.inputType !== "historyUndo") {
                        that.save(area);
                    }
                    if (e.inputType === "historyUndo") {
                        e.preventDefault();
                        that.undo(area);
                    }
                    if (e.inputType === "insertFromPaste" || e.inputType === "insertFromDrop") {
                        that.get(e);
                        if (!that.hot) { return; }
                        e.preventDefault();
                        that.put();
                    }
                });
                area.addEventListener("input", function (e) {
                    if (e.inputType === "insertFromPaste" || e.inputType === "insertFromDrop") {
                        that.undo(area, false);
                        that.hot = true;
                        that.put();
                    };
                });
                area.addEventListener("mousedown", function () { that.press(area); });
                area.addEventListener("touchstart", function () { that.press(area); });
                area.addEventListener("mouseup", function () { that.loose(); });
                area.addEventListener("touchend", function () { that.loose(); });
                area.addEventListener("touchcancel", function () { that.loose(); });
                document.addEventListener("selectionchange", function (e) { if (that.move) { that.loose(); } else { that.move = true; } });
            };
        };
        DropEditor.watch("div[contenteditable='true']");
    </script>
</body>

</html>
